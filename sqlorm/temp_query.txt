
SELECT * FROM commitment_treasury WHERE commitment_number = '0015271220000000214' AND registration_date = (SELECT MIN(registration_date) FROM commitment_treasury WHERE commitment_number = '0015271220000000214');


(SELECT MIN(registration_date) FROM commitment_treasury WHERE commitment_number = '0015271220000000214')



FOR temprow IN
        SELECT * 
		FROM commitment_treasury 
		WHERE commitment_number 
		IN (SELECT commitment_number FROM budget_commitment)
    LOOP
		INSERT INTO temptable (commitment_number)		
        SELECT index 
		FROM commitment_treasury 
		WHERE commitment_number = temprow.commitment_number
		AND registration_date = (SELECT MAX(registration_date) FROM commitment_treasury WHERE commitment_number = temprow.commitment_number)
    END LOOP;


ROLLBACK;
BEGIN;
CREATE TEMP TABLE temptable -- стоит использовать наиболее уникальное имя
ON COMMIT DROP -- удаляем таблицу при завершении транзакции
AS 
SELECT 1 AS id, CAST ('какие-то значения' AS TEXT) AS val;
ALTER TABLE temptable 
ADD COLUMN commitment_number TEXT;

FOR temprow IN 
SELECT commitment_number FROM commitment_treasury WHERE commitment_number IN (SELECT commitment_number FROM budget_commitment) 
LOOP
INSERT INTO temptable (commitment_number)		
SELECT index 
FROM commitment_treasury 
WHERE commitment_number = temprow.commitment_number
AND registration_date = (SELECT MAX(registration_date) FROM commitment_treasury WHERE commitment_number = temprow.commitment_number)
END LOOP;
END;
SELECT * FROM temptable;



CREATE TEMP TABLE temptable -- стоит использовать наиболее уникальное имя
ON COMMIT DROP -- удаляем таблицу при завершении транзакции
AS 
SELECT 1 AS id, CAST ('какие-то значения' AS TEXT) AS val;
ALTER TABLE temptable 
ADD COLUMN commitment_number TEXT;
DO 
$$
DECLARE 
  num text;  
BEGIN
   FOR num 
   IN 
   	SELECT commitment_number		
   	FROM commitment_treasury 
	WHERE commitment_number 
	IN (
		SELECT commitment_number			
		FROM budget_commitment)
   LOOP
	INSERT INTO temptable (commitment_number)		
	SELECT index 
	FROM commitment_treasury 
	WHERE commitment_number = num
	AND registration_date = (SELECT MAX(registration_date) FROM commitment_treasury WHERE commitment_number = num);
   END loop;
PERFORM commitment_number FROM temptable;
END;
$$;

SELECT * FROM commitment_treasury
WHERE index
IN (
    SELECT commitment_number FROM temptable
)

